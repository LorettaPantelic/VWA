<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Timer</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f6f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background: white;
            padding: 24px;
            border-radius: 16px;
            width: 520px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 16px;
        }

        .time-input {
        width: 100%;
        border: 2px solid #ddd;
        border-radius: 12px;
        padding: 20px;
        font-size: 48px;
        text-align: center;
        margin-bottom: 16px;
        font-variant-numeric: tabular-nums;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        button {
            padding: 16px;
            font-size: 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }

        .start {
            flex: 1;
            background: #4ca34f;
            color: white;
        }

        .reset {
            background: #e5e7eb;
            width: 60px;
        }

        .presets {
            display: flex;
            gap: 12px;
        }

        .preset {
            flex: 1;
            background: #e5e7eb;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Countdown Timer</h1>

    <input id="timeField" class="time-input" value="10:00" onclick="this.select()">

    <div class="controls">
        <button class="start" onclick="startTimer()">▶ Start</button>
        <button class="reset" onclick="resetTimer()">↺</button>
    </div>

    <div class="presets">
        <button class="preset" onclick="setPreset(5)">5 Min</button>
        <button class="preset" onclick="setPreset(10)">10 Min</button>
        <button class="preset" onclick="setPreset(15)">15 Min</button>
    </div>
</div>

<script>
    let running = false;
    let remainingSeconds = 600.0; // float für präzise Millisekunden
    let lastSetSeconds = 600.0;
    let intervalId = null;
    let startTimestamp = null;

    const timeField = document.getElementById("timeField");
    const startBtn = document.querySelector(".start");

    function parseAndFormat(input) {
        input = input.trim();
        let minutes = 0, seconds = 0;
        if (/^\d+$/.test(input)) {
            minutes = parseInt(input);
        } else if (/^\d+:\d+$/.test(input)) {
            [minutes, seconds] = input.split(":").map(Number);
        }
        seconds = Math.min(seconds, 59);
        return minutes * 60 + seconds;
    }

    function formatTime(totalSeconds, ms = 0) {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        const cs = Math.floor(ms / 10);
        return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${String(cs).padStart(2,"0")}`;
    }

    function updateDisplay() {
        timeField.value = formatTime(Math.floor(remainingSeconds), (remainingSeconds - Math.floor(remainingSeconds)) * 1000);
    }

    function updateTimerDisplay() {
        const elapsed = (performance.now() - startTimestamp) / 1000;
        const left = Math.max(0, lastSetSeconds - elapsed);
        remainingSeconds = left;
        updateDisplay();
        if (left <= 0) stopTimer();
    }

    function startTimer() {
        if (!running) {
            remainingSeconds = parseAndFormat(timeField.value);
            lastSetSeconds = remainingSeconds;
            startTimestamp = performance.now();
            updateDisplay();

            fetch("/update_timer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    mode: "timer",
                    duration: remainingSeconds,
                    running: true
                })
            });

            startBtn.textContent = "■ Stop";
            startBtn.style.background = "#dc2626";
            running = true;

            intervalId = setInterval(updateTimerDisplay, 50);
        } else {
            stopTimer();
        }
    }

    function stopTimer() {
        if (!running) return;
        clearInterval(intervalId);
        running = false;
        lastSetSeconds = remainingSeconds; 
        fetch("/update_timer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ running: false })
        });
        startBtn.textContent = "▶ Start";
        startBtn.style.background = "#4ca34f";
    }

    function resetTimer() {
        stopTimer();
        remainingSeconds = lastSetSeconds;
        updateDisplay();
    }

    function setPreset(min) {
        stopTimer();
        remainingSeconds = min * 60;
        lastSetSeconds = remainingSeconds;
        updateDisplay();
    }

    timeField.addEventListener("blur", () => {
        remainingSeconds = parseAndFormat(timeField.value);
        lastSetSeconds = remainingSeconds;
        updateDisplay();

        // --- Server informieren ---
        fetch("/update_timer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                duration: remainingSeconds,
                running: running // true/false je nachdem
            })
        });
    });

    // --- Server-Synchronisation ---
    async function syncFromServer() {
        try {
            const res = await fetch("/get_state");
            const data = await res.json();

            if (data.timer_running) {
                const elapsed = (Date.now()/1000 - data.timer_start_ts);
                remainingSeconds = data.timer_duration - elapsed;
                lastSetSeconds = remainingSeconds;
                startTimestamp = performance.now() - elapsed * 1000;
                running = true;
                startBtn.textContent = "■ Stop";
                startBtn.style.background = "#dc2626";
                intervalId = setInterval(updateTimerDisplay, 50);
            } else {
                remainingSeconds = data.remaining_seconds;
                lastSetSeconds = remainingSeconds;
            }
            updateDisplay();
        } catch (err) {
            console.error("Fehler beim Laden des Server-Timers:", err);
        }
    }
    syncFromServer();

    // Polling für Web <-> Pi Synchronisation
    setInterval(async () => {
        if (!running) {
            try {
                const res = await fetch("/get_state");
                const data = await res.json();
                remainingSeconds = data.remaining_seconds;
                lastSetSeconds = remainingSeconds;
                updateDisplay();
            } catch {}
        }
    }, 500);

</script>

</body>
</html>
