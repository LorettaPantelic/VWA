{% extends "base.html" %}
{% block content %}

<style>

    .container {
        background: white;
        padding: 24px;
        border-radius: 16px;
        width: 520px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    h1 {
        margin-bottom: 16px;
    }

    .time-input {
    width: 100%;
    box-sizing: border-box;
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 20px;
    font-size: 48px;
    text-align: center;
    margin-bottom: 16px;
    font-variant-numeric: tabular-nums;
    }

    .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    button {
        padding: 16px;
        font-size: 20px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        position: relative;
        box-sizing: border-box;

        min-height: 58.5px;

        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-text {
        display: flex;
        align-items: center;
        line-height: 1;
    }

    .btn-placeholder {
        visibility: hidden;
        position: absolute;
        left: 0;
        right: 0;
        text-align: center;
        pointer-events: none;
    }

    .start {
        flex: 1;
        background: #4ca34f;
        color: white;
    }

    .stop {
        flex: 1;
        background: #dc2626;
        color: white;
    }

    .reset {
        background: #e5e7eb;
        width: 60px;
    }

    .presets {
        display: flex;
        gap: 12px;
    }

    .preset {
        flex: 1;
        background: #e5e7eb;
    }
</style>

<div class="container">
    <h1>Timer</h1>

    <input id="timeField" class="time-input" value="10:00" onclick="this.select()">

    <div class="controls">
        <button id="startBtn" class="start" onclick="startTimer()">
            <span class="btn-text">▶ Start</span>
            <span class="btn-placeholder" aria-hidden="true">■ Stopp</span>
        </button>
        <button class="reset" onclick="resetTimer()">↺</button>
    </div>

    <div class="presets">
        <button class="preset" onclick="setPreset(5)">5 Min</button>
        <button class="preset" onclick="setPreset(10)">10 Min</button>
        <button class="preset" onclick="setPreset(15)">15 Min</button>
    </div>
</div>

<script>
    let running = false;
    let remainingSeconds = 600.0; // Use float for precise milliseconds
    let lastSetSeconds = 600.0;
    let initialSeconds = 600.0;
    let intervalId = null;
    let startTimestamp = null;
    let editing = false;

    const timeField = document.getElementById("timeField");
    const startBtn = document.getElementById("startBtn");
    const btnText = startBtn.querySelector(".btn-text");
    
    timeField.addEventListener("focus", () => {
        editing = true;
    });

    timeField.addEventListener("input", () => {
        editing = true;
    });

    function parseAndFormat(input) {
        input = input.trim();
        let minutes = 0, seconds = 0;
        if (/^\d+$/.test(input)) {
            minutes = parseInt(input);
        } else if (/^\d+:\d+$/.test(input)) {
            [minutes, seconds] = input.split(":").map(Number);
        }
        seconds = Math.min(seconds, 59);
        return minutes * 60 + seconds;
    }

    function formatTime(totalSeconds, ms = 0) {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        const cs = Math.floor(ms / 10);
        return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${String(cs).padStart(2,"0")}`;
    }

    function updateDisplay() {
        if (editing) return;
        timeField.value = formatTime(
            Math.floor(remainingSeconds),
            (remainingSeconds - Math.floor(remainingSeconds)) * 1000
        );
    }

    function updateTimerDisplay() {
        if (editing) return;

        const elapsed = (performance.now() - startTimestamp) / 1000;
        const left = Math.max(0, lastSetSeconds - elapsed);
        remainingSeconds = left;
        updateDisplay();

        if (left <= 0) stopTimer();
    }

    function startTimer() {
        if (!running) {
            lastSetSeconds = remainingSeconds;
            startTimestamp = performance.now();
            updateDisplay();

            fetch("/timer/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    mode: "timer",
                    duration: remainingSeconds,
                    running: true
                })
            });

            btnText.textContent = "■ Stopp";
            startBtn.classList.remove("start");
            startBtn.classList.add("stop");
            running = true;

            intervalId = setInterval(updateTimerDisplay, 50);
        } else {
            stopTimer();
        }
    }

    function stopTimer() {
        if (!running) return;
        clearInterval(intervalId);
        running = false;
        lastSetSeconds = remainingSeconds; 

        btnText.textContent = "▶ Start";
        startBtn.classList.remove("stop");
        startBtn.classList.add("start");

        fetch("/timer/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ running: false })
        });
    }

    function resetTimer() {
        stopTimer();
        remainingSeconds = initialSeconds;
        lastSetSeconds = initialSeconds;
        updateDisplay();

        btnText.textContent = "▶ Start";
        startBtn.classList.remove("stop");
        startBtn.classList.add("start");

        fetch("/timer/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                duration: remainingSeconds,
                running: false
            })
        });
    }

    function setPreset(min) {
        stopTimer();
        remainingSeconds = min * 60;
        lastSetSeconds = remainingSeconds;
        initialSeconds = remainingSeconds;
        updateDisplay();

        fetch("/timer/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                duration: remainingSeconds,
                running: false
            })
        });
    }

    timeField.addEventListener("blur", () => {
        editing = false;

        // Evaluate MM:SS only (ignore milliseconds)
        const raw = timeField.value.split(".")[0];
        const newSeconds = parseAndFormat(raw);

        if (!isNaN(newSeconds) && newSeconds > 0) {
            remainingSeconds = newSeconds;
            lastSetSeconds = newSeconds;
            initialSeconds = newSeconds;

            fetch("/timer/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    duration: remainingSeconds,
                    running: false
                })
            });
        }

        updateDisplay();
    });

    // --- Server synchronization ---
    async function syncFromServer() {
        try {
            const res = await fetch("/get_state");
            const data = await res.json();

            if (data.timer_running) {
                const elapsed = (Date.now()/1000 - data.timer_start_ts);
                remainingSeconds = data.timer_duration - elapsed;
                lastSetSeconds = remainingSeconds;
                startTimestamp = performance.now() - elapsed * 1000;
                running = true;
                startBtn.textContent = "■ Stopp";
                startBtn.style.background = "#dc2626";
                intervalId = setInterval(updateTimerDisplay, 50);
            } else {
                remainingSeconds = data.remaining_seconds;
                lastSetSeconds = remainingSeconds;
            }
            updateDisplay();
        } catch (err) {
            console.error("Fehler beim Laden des Server-Timers:", err);
        }
    }
    syncFromServer();

    // Polling for web <-> Pi synchronization
    setInterval(async () => {
        if (!running) {
            try {
                const res = await fetch("/get_state");
                const data = await res.json();
                remainingSeconds = data.remaining_seconds;
                lastSetSeconds = remainingSeconds;
                updateDisplay();
            } catch {}
        }
    }, 500);

</script>

{% endblock %}